---
title: Personalizzazione delle autorizzazioni con rappresentazione in SQL Server
ms.date: 03/30/2017
ms.assetid: dc733d09-1d6d-4af0-9c4b-8d24504860f1
ms.openlocfilehash: bfee153a1293ec89285dbeabd1ed64a89764a717
ms.sourcegitcommit: 2eceb05f1a5bb261291a1f6a91c5153727ac1c19
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 09/04/2018
ms.locfileid: "43513972"
---
# <a name="customizing-permissions-with-impersonation-in-sql-server"></a><span data-ttu-id="e8fa6-102">Personalizzazione delle autorizzazioni con rappresentazione in SQL Server</span><span class="sxs-lookup"><span data-stu-id="e8fa6-102">Customizing Permissions with Impersonation in SQL Server</span></span>
<span data-ttu-id="e8fa6-103">In molte applicazioni vengono usate le stored procedure per accedere ai dati, basandosi sul concatenamento delle proprietà per restringere l'accesso alle tabelle di base.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-103">Many applications use stored procedures to access data, relying on ownership chaining to restrict access to base tables.</span></span> <span data-ttu-id="e8fa6-104">È possibile concedere autorizzazioni EXECUTE sulle stored procedure, revocando o negando le autorizzazioni sulle tabelle di base.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-104">You can grant EXECUTE permissions on stored procedures, revoking or denying permissions on the base tables.</span></span> <span data-ttu-id="e8fa6-105">SQL Server non verifica le autorizzazioni del chiamante se il proprietario della stored procedure coincide con quello delle tabelle.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-105">SQL Server does not check the permissions of the caller if the stored procedure and tables have the same owner.</span></span> <span data-ttu-id="e8fa6-106">Il concatenamento delle proprietà non funziona se i proprietari degli oggetti sono diversi oppure se si usano istruzioni SQL dinamiche.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-106">However, ownership chaining doesn't work if objects have different owners or in the case of dynamic SQL.</span></span>  
  
 <span data-ttu-id="e8fa6-107">È possibile usare la clausola EXECUTE AS in una stored procedure quando il chiamante non dispone delle autorizzazioni sugli oggetti di database cui viene fatto riferimento.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-107">You can use the EXECUTE AS clause in a stored procedure when the caller doesn't have permissions on the referenced database objects.</span></span> <span data-ttu-id="e8fa6-108">Per effetto della clausola EXECUTE AS il contesto di esecuzione viene passato all'utente proxy.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-108">The effect of the EXECUTE AS clause is that the execution context is switched to the proxy user.</span></span> <span data-ttu-id="e8fa6-109">Tutto il codice, nonché qualsiasi chiamata a stored procedure o trigger annidati, viene eseguito nel contesto di sicurezza dell'utente proxy.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-109">All code, as well as any calls to nested stored procedures or triggers, executes under the security context of the proxy user.</span></span> <span data-ttu-id="e8fa6-110">Viene ripristinato il contesto di esecuzione del chiamante originale solo dopo l'esecuzione della stored procedure o quando viene eseguita un'istruzione REVERT.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-110">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
## <a name="context-switching-with-the-execute-as-statement"></a><span data-ttu-id="e8fa6-111">Cambio del contesto con l'istruzione EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="e8fa6-111">Context Switching with the EXECUTE AS Statement</span></span>  
 <span data-ttu-id="e8fa6-112">L'istruzione EXECUTE AS Transact-SQL consente di cambiare il contesto di esecuzione di un'istruzione mediante la rappresentazione di un altro account di accesso o utente del database.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-112">The Transact-SQL EXECUTE AS statement allows you to switch the execution context of a statement by impersonating another login or database user.</span></span> <span data-ttu-id="e8fa6-113">Si tratta di una tecnica utile per testare query e stored procedure usando le credenziali di un altro utente.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-113">This is a useful technique for testing queries and procedures as another user.</span></span>  
  
```  
EXECUTE AS LOGIN = 'loginName';  
EXECUTE AS USER = 'userName';  
```  
  
 <span data-ttu-id="e8fa6-114">È necessario disporre delle autorizzazioni IMPERSONATE per l'account di accesso o l'utente che si intende rappresentare.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-114">You must have IMPERSONATE permissions on the login or user you are impersonating.</span></span> <span data-ttu-id="e8fa6-115">Questa autorizzazione è implica per `sysadmin` su tutti i database e per i membri del ruolo `db_owner` sui database di cui sono proprietari.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-115">This permission is implied for `sysadmin` for all databases, and `db_owner` role members in databases that they own.</span></span>  
  
## <a name="granting-permissions-with-the-execute-as-clause"></a><span data-ttu-id="e8fa6-116">Concessione delle autorizzazioni con la clausola EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="e8fa6-116">Granting Permissions with the EXECUTE AS Clause</span></span>  
 <span data-ttu-id="e8fa6-117">È possibile usare la clausola EXECUTE AS nell'intestazione della definizione di una stored procedure, un trigger o una funzione definita dall'utente, ad eccezione delle funzioni inline valutate a livello di tabella.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-117">You can use the EXECUTE AS clause in the definition header of a stored procedure, trigger, or user-defined function (except for inline table-valued functions).</span></span> <span data-ttu-id="e8fa6-118">La stored procedure viene quindi eseguita nel contesto del nome utente o della parola chiave specificata nella clausola EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-118">This causes the procedure to execute in the context of the user name or keyword specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="e8fa6-119">È possibile creare un utente proxy nel database di cui non è stato eseguito il mapping a un account di accesso, concedendo solo le autorizzazioni necessarie sugli oggetti cui la stored procedure ha accesso.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-119">You can create a proxy user in the database that is not mapped to a login, granting it only the necessary permissions on the objects accessed by the procedure.</span></span> <span data-ttu-id="e8fa6-120">Solo l'utente proxy specificato nella clausola EXECUTE AS deve disporre delle autorizzazioni su tutti gli oggetti cui il modulo ha accesso.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-120">Only the proxy user specified in the EXECUTE AS clause must have permissions on all objects accessed by the module.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8fa6-121">Per alcune azioni, ad esempio TRUNCATE TABLE, non sono disponibili autorizzazioni da concedere.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-121">Some actions, such as TRUNCATE TABLE, do not have grantable permissions.</span></span> <span data-ttu-id="e8fa6-122">Incorporando l'istruzione all'interno di una stored procedure e specificando un utente proxy che dispone delle autorizzazioni ALTER TABLE, è possibile estendere le autorizzazioni necessarie per troncare la tabella ai chiamanti che dispongono solo delle autorizzazioni EXECUTE per la stored procedure.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-122">By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.</span></span>  
  
 <span data-ttu-id="e8fa6-123">Il contesto specificato nella clausola EXECUTE AS è valido per la durata della stored procedura, incluse stored procedure e trigger annidati.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-123">The context specified in the EXECUTE AS clause is valid for the duration of the procedure, including nested procedures and triggers.</span></span> <span data-ttu-id="e8fa6-124">Il contesto ritorna al chiamante al termine dell'esecuzione o quando viene eseguita l'istruzione REVERT.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-124">Context reverts to the caller when execution is complete or the REVERT statement is issued.</span></span>  
  
 <span data-ttu-id="e8fa6-125">L'uso di una clausola EXECUTE AS in una stored procedure implica tre passaggi:</span><span class="sxs-lookup"><span data-stu-id="e8fa6-125">There are three steps involved in using the EXECUTE AS clause in a procedure.</span></span>  
  
1.  <span data-ttu-id="e8fa6-126">Creazione di un utente proxy nel database non mappato a un account di accesso.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-126">Create a proxy user in the database that is not mapped to a login.</span></span> <span data-ttu-id="e8fa6-127">Questo passaggio non è necessario ma risulta utile durante la gestione delle autorizzazioni.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-127">This is not required, but it helps when managing permissions.</span></span>  
  
```  
CREATE USER proxyUser WITHOUT LOGIN  
```  
  
1.  <span data-ttu-id="e8fa6-128">Concessione delle autorizzazioni necessarie all'utente proxy.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-128">Grant the proxy user the necessary permissions.</span></span>  
  
2.  <span data-ttu-id="e8fa6-129">Aggiunta della clausola EXECUTE AS alla stored procedure o alla funzione definita dall'utente.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-129">Add the EXECUTE AS clause to the stored procedure or user-defined function.</span></span>  
  
```  
CREATE PROCEDURE [procName] WITH EXECUTE AS 'proxyUser' AS ...  
```  
  
> [!NOTE]
>  <span data-ttu-id="e8fa6-130">È possibile che le applicazioni che richiedono il controllo vengano interrotte perché il contesto di sicurezza originale del chiamante non viene mantenuto.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-130">Applications that require auditing can break because the original security context of the caller is not retained.</span></span> <span data-ttu-id="e8fa6-131">Le funzioni predefinite che restituiscono l'identità dell'utente corrente, ad esempio SESSION_USER, USER, o USER_NAME, restituiscono l'utente associato alla clausola EXECUTE AS, non il chiamante originale.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-131">Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.</span></span>  
  
### <a name="using-execute-as-with-revert"></a><span data-ttu-id="e8fa6-132">Uso di EXECUTE AS con REVERT</span><span class="sxs-lookup"><span data-stu-id="e8fa6-132">Using EXECUTE AS with REVERT</span></span>  
 <span data-ttu-id="e8fa6-133">È possibile usare l'istruzione REVERT Transact-SQL per ripristinare il contesto di esecuzione originale.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-133">You can use the Transact-SQL REVERT statement to revert to the original execution context.</span></span>  
  
 <span data-ttu-id="e8fa6-134">La clausola facoltativa WITH NO REVERT COOKIE = @variableName, consente passare il contesto di esecuzione al chiamante se il @variableName variabile contiene il valore corretto.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-134">The optional clause, WITH NO REVERT COOKIE = @variableName, allows you switch the execution context back to the caller if the @variableName variable contains the correct value.</span></span> <span data-ttu-id="e8fa6-135">Viene quindi ripristinato il contesto di esecuzione del chiamante negli ambienti in cui viene usato il pool di connessioni.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-135">This allows you to switch the execution context back to the caller in environments where connection pooling is used.</span></span> <span data-ttu-id="e8fa6-136">Poiché il valore di @variableName è noto solo al chiamante di EXECUTE AS istruzione, il chiamante può garantire che il contesto di esecuzione non venga modificato dall'utente finale che richiama l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-136">Because the value of @variableName is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application.</span></span> <span data-ttu-id="e8fa6-137">Alla chiusura della connessione, il contesto viene restituito al pool.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-137">When the connection is closed, it is returned to the pool.</span></span> <span data-ttu-id="e8fa6-138">Per altre informazioni sulla connessione pool di connessioni in ADO.NET, vedere [SQL Server Connection pool (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="e8fa6-138">For more information on connection pooling in ADO.NET, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span></span>  
  
### <a name="specifying-the-execution-context"></a><span data-ttu-id="e8fa6-139">Specifica del contesto di esecuzione</span><span class="sxs-lookup"><span data-stu-id="e8fa6-139">Specifying the Execution Context</span></span>  
 <span data-ttu-id="e8fa6-140">Oltre a specificare un utente, è inoltre possibile usare EXECUTE AS con le parole chiave seguenti.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-140">In addition to specifying a user, you can also use EXECUTE AS with any of the following keywords.</span></span>  
  
-   <span data-ttu-id="e8fa6-141">CALLER.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-141">CALLER.</span></span> <span data-ttu-id="e8fa6-142">L'esecuzione come CALLER corrisponde all'impostazione predefinita. Se non vengono specificate altre opzioni, la stored procedure viene eseguita nel contesto di sicurezza del chiamante.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-142">Executing as CALLER is the default; if no other option is specified, then the procedure executes in the security context of the caller.</span></span>  
  
-   <span data-ttu-id="e8fa6-143">OWNER.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-143">OWNER.</span></span> <span data-ttu-id="e8fa6-144">Con questa parola chiave la stored procedure viene eseguita nel contesto del proprietario.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-144">Executing as OWNER executes the procedure in the context of the procedure owner.</span></span> <span data-ttu-id="e8fa6-145">Se la stored procedure viene creata in uno schema di cui è proprietario `dbo` o il proprietario del database, verrà eseguita con autorizzazioni senza restrizioni.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-145">If the procedure is created in a schema owned by `dbo` or the database owner, the procedure will execute with unrestricted permissions.</span></span>  
  
-   <span data-ttu-id="e8fa6-146">SELF.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-146">SELF.</span></span> <span data-ttu-id="e8fa6-147">Con questa parola chiave la stored procedure viene eseguita nel contesto di sicurezza del creatore.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-147">Executing as SELF executes in the security context of the creator of the stored procedure.</span></span> <span data-ttu-id="e8fa6-148">Questa opzione equivale all'esecuzione come utente specificato, dove l'utente specificato è la persona che crea o modifica la stored procedure.</span><span class="sxs-lookup"><span data-stu-id="e8fa6-148">This is equivalent to executing as a specified user, where the specified user is the person creating or altering the procedure.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e8fa6-149">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="e8fa6-149">See Also</span></span>  
 [<span data-ttu-id="e8fa6-150">Protezione delle applicazioni ADO.NET</span><span class="sxs-lookup"><span data-stu-id="e8fa6-150">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)  
 [<span data-ttu-id="e8fa6-151">Cenni preliminari sulla sicurezza in SQL Server</span><span class="sxs-lookup"><span data-stu-id="e8fa6-151">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)  
 [<span data-ttu-id="e8fa6-152">Scenari di sicurezza delle applicazioni in SQL Server</span><span class="sxs-lookup"><span data-stu-id="e8fa6-152">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)  
 [<span data-ttu-id="e8fa6-153">Gestione delle autorizzazioni con stored procedure in SQL Server</span><span class="sxs-lookup"><span data-stu-id="e8fa6-153">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="e8fa6-154">Scrittura dinamica sicura in SQL Server</span><span class="sxs-lookup"><span data-stu-id="e8fa6-154">Writing Secure Dynamic SQL in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)  
 [<span data-ttu-id="e8fa6-155">Firma di stored procedure in SQL Server</span><span class="sxs-lookup"><span data-stu-id="e8fa6-155">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="e8fa6-156">Modifica di dati con stored procedure</span><span class="sxs-lookup"><span data-stu-id="e8fa6-156">Modifying Data with Stored Procedures</span></span>](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)  
 [<span data-ttu-id="e8fa6-157">Provider gestiti ADO.NET e Centro per sviluppatori di set di dati</span><span class="sxs-lookup"><span data-stu-id="e8fa6-157">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
