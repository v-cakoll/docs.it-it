---
title: 'Procedura dettagliata: Creazione di codice in scenari di attendibilità parziale'
description: Vedere come creare codice in scenari di attendibilità parziale. La reflection emit usa le stesse API, ma alcune funzionalità richiedono autorizzazioni speciali in codice parzialmente attendibile.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- reflection emit, anonymously hosted dynamic methods
- partial trust, reflection
- partial trust, emitting dynamic methods
- reflection emit, partial trust scenarios
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- reflection emit, dynamic methods
- dynamic methods
ms.assetid: c45be261-2a9d-4c4e-9bd6-27f0931b7d25
ms.openlocfilehash: 70adb3ce67b45459b18741948092a912f6173731
ms.sourcegitcommit: 3d84eac0818099c9949035feb96bbe0346358504
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/21/2020
ms.locfileid: "86865190"
---
# <a name="walkthrough-emitting-code-in-partial-trust-scenarios"></a><span data-ttu-id="a354d-104">Procedura dettagliata: Creazione di codice in scenari di attendibilità parziale</span><span class="sxs-lookup"><span data-stu-id="a354d-104">Walkthrough: Emitting Code in Partial Trust Scenarios</span></span>

<span data-ttu-id="a354d-105">La reflection emit usa le stesse API in scenari di attendibilità sia parziale che completa, ma alcune funzionalità richiedono autorizzazioni speciali nel codice parzialmente attendibile.</span><span class="sxs-lookup"><span data-stu-id="a354d-105">Reflection emit uses the same API set in full or partial trust, but some features require special permissions in partially trusted code.</span></span> <span data-ttu-id="a354d-106">Inoltre, la reflection emit include una funzionalità, i metodi dinamici ospitati in modo anonimo, progettata per l'uso in situazioni di attendibilità parziale da parte di assembly trasparenti per la sicurezza.</span><span class="sxs-lookup"><span data-stu-id="a354d-106">In addition, reflection emit has a feature, anonymously hosted dynamic methods, that is designed to be used with partial trust and by security-transparent assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="a354d-107">Prima di .NET Framework 3.5, la creazione di codice richiedeva <xref:System.Security.Permissions.ReflectionPermission> con il flag <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="a354d-107">Before .NET Framework 3.5, emitting code required <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="a354d-108">Questa autorizzazione è inclusa per impostazione predefinita nei set di autorizzazioni denominati `FullTrust` e `Intranet`, ma non nel set di autorizzazioni `Internet`.</span><span class="sxs-lookup"><span data-stu-id="a354d-108">This permission is included by default in the `FullTrust` and `Intranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="a354d-109">Di conseguenza, una libreria può essere usata con attendibilità parziale solo se in essa era presente l'attributo <xref:System.Security.SecurityCriticalAttribute> e veniva eseguito un metodo <xref:System.Security.PermissionSet.Assert%2A> per <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span><span class="sxs-lookup"><span data-stu-id="a354d-109">Therefore, a library could be used from partial trust only if it had the <xref:System.Security.SecurityCriticalAttribute> attribute and also executed an <xref:System.Security.PermissionSet.Assert%2A> method for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="a354d-110">Tali librerie richiedono un'attenta revisione della sicurezza perché eventuali errori nel codice potrebbe produrre delle vulnerabilità.</span><span class="sxs-lookup"><span data-stu-id="a354d-110">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="a354d-111">.NET Framework 3.5 consente di generare codice in scenari con attendibilità parziale senza creare alcuna richiesta di sicurezza, poiché la generazione di codice non è implicitamente un'operazione con privilegi.</span><span class="sxs-lookup"><span data-stu-id="a354d-111">The .NET Framework 3.5 allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="a354d-112">Ovvero, il codice generato non dispone di ulteriori autorizzazioni rispetto all'assembly che lo genera.</span><span class="sxs-lookup"><span data-stu-id="a354d-112">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="a354d-113">Questo consente alle librerie che generano il codice di essere trasparenti per la sicurezza ed elimina la necessità di asserire <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, quindi la scrittura di una libreria protetta non richiede una revisione completa della sicurezza.</span><span class="sxs-lookup"><span data-stu-id="a354d-113">This enables libraries that emit code to be security-transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, so that writing a secure library does not require such a thorough security review.</span></span>

<span data-ttu-id="a354d-114">Vengono illustrate le attività seguenti:</span><span class="sxs-lookup"><span data-stu-id="a354d-114">This walkthrough illustrates the following tasks:</span></span>

- <span data-ttu-id="a354d-115">[Configurazione di un oggetto sandbox semplice per il test del codice parzialmente attendibile](#Setting_up).</span><span class="sxs-lookup"><span data-stu-id="a354d-115">[Setting up a simple sandbox for testing partially trusted code](#Setting_up).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="a354d-116">Questo è un modo semplice per sperimentare il codice in situazioni di attendibilità parziale.</span><span class="sxs-lookup"><span data-stu-id="a354d-116">This is a simple way to experiment with code in partial trust.</span></span> <span data-ttu-id="a354d-117">Per eseguire codice realmente proveniente da percorsi non attendibili, vedere la [procedura relativa all'esecuzione di codice parzialmente attendibile in un oggetto sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="a354d-117">To run code that actually comes from untrusted locations, see [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

- <span data-ttu-id="a354d-118">[Esecuzione di codice in domini di applicazioni parzialmente attendibili](#Running_code).</span><span class="sxs-lookup"><span data-stu-id="a354d-118">[Running code in partially trusted application domains](#Running_code).</span></span>

- <span data-ttu-id="a354d-119">[Uso di metodi dinamici ospitati in modo anonimo per generare ed eseguire codice in situazioni di attendibilità parziale](#Using_methods).</span><span class="sxs-lookup"><span data-stu-id="a354d-119">[Using anonymously hosted dynamic methods to emit and execute code in partial trust](#Using_methods).</span></span>

<span data-ttu-id="a354d-120">Per altre informazioni sulla generazione di codice in scenari di attendibilità parziale, vedere la sezione relativa ai [problemi di sicurezza nella reflection emit](security-issues-in-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="a354d-120">For more information about emitting code in partial trust scenarios, see [Security Issues in Reflection Emit](security-issues-in-reflection-emit.md).</span></span>

<span data-ttu-id="a354d-121">Per un elenco completo del codice riportato in queste procedure, vedere la [sezione degli esempi](#Example) alla fine di questa procedura dettagliata.</span><span class="sxs-lookup"><span data-stu-id="a354d-121">For a complete listing of the code shown in these procedures, see the [Example section](#Example) at the end of this walkthrough.</span></span>

<a name="Setting_up"></a>

## <a name="setting-up-partially-trusted-locations"></a><span data-ttu-id="a354d-122">Impostazione di percorsi parzialmente attendibili</span><span class="sxs-lookup"><span data-stu-id="a354d-122">Setting up Partially Trusted Locations</span></span>

<span data-ttu-id="a354d-123">Le due procedure seguenti illustrano come impostare i percorsi da cui è possibile testare il codice con attendibilità parziale.</span><span class="sxs-lookup"><span data-stu-id="a354d-123">The following two procedures show how to set up locations from which you can test code with partial trust.</span></span>

- <span data-ttu-id="a354d-124">La prima procedura spiega come creare un dominio dell'applicazione sandbox in cui vengono concesse autorizzazioni Internet al codice.</span><span class="sxs-lookup"><span data-stu-id="a354d-124">The first procedure shows how to create a sandboxed application domain in which code is granted Internet permissions.</span></span>

- <span data-ttu-id="a354d-125">La seconda procedura illustra come aggiungere <xref:System.Security.Permissions.ReflectionPermission> con il flag <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> a un dominio dell'applicazione parzialmente attendibile, per consentire l'accesso ai dati privati negli assembly con attendibilità uguale o inferiore.</span><span class="sxs-lookup"><span data-stu-id="a354d-125">The second procedure shows how to add <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag to a partially trusted application domain, to enable access to private data in assemblies of equal or lesser trust.</span></span>

### <a name="creating-sandboxed-application-domains"></a><span data-ttu-id="a354d-126">Creazione di domini dell'applicazione sandbox</span><span class="sxs-lookup"><span data-stu-id="a354d-126">Creating Sandboxed Application Domains</span></span>

<span data-ttu-id="a354d-127">Per creare un dominio applicazione in cui gli assembly sono eseguiti con attendibilità parziale, è necessario specificare il set di autorizzazioni da concedere agli assembly usando l'overload del metodo <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> per creare il dominio dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-127">To create an application domain in which your assemblies run with partial trust, you must specify the set of permissions to be granted to the assemblies by using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to create the application domain.</span></span> <span data-ttu-id="a354d-128">Il modo più semplice per specificare il set di concessioni è recuperare un set di autorizzazioni denominato dai criteri di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="a354d-128">The easiest way to specify the grant set is to retrieve a named permission set from security policy.</span></span>

<span data-ttu-id="a354d-129">Nella procedura seguente viene creato un dominio dell'applicazione sandbox che esegue il codice con attendibilità parziale, per testare gli scenari in cui il codice generato può accedere solo ai membri pubblici dei tipi pubblici.</span><span class="sxs-lookup"><span data-stu-id="a354d-129">The following procedure creates a sandboxed application domain that runs your code with partial trust, to test scenarios in which emitted code can access only public members of public types.</span></span> <span data-ttu-id="a354d-130">Una procedura successiva illustra come aggiungere <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, per testare scenari in cui il codice generato può accedere a tipi e membri non pubblici negli assembly a cui vengono concesse autorizzazioni uguali o inferiori.</span><span class="sxs-lookup"><span data-stu-id="a354d-130">A subsequent procedure shows how to add <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, to test scenarios in which emitted code can access nonpublic types and members in assemblies that are granted equal or lesser permissions.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust"></a><span data-ttu-id="a354d-131">Per creare un dominio dell'applicazione con attendibilità parziale</span><span class="sxs-lookup"><span data-stu-id="a354d-131">To create an application domain with partial trust</span></span>

1. <span data-ttu-id="a354d-132">Creare un set di autorizzazioni da concedere agli assembly nel dominio dell'applicazione sandbox.</span><span class="sxs-lookup"><span data-stu-id="a354d-132">Create a permission set to grant to the assemblies in the sandboxed application domain.</span></span> <span data-ttu-id="a354d-133">In questo caso viene usato il set di autorizzazioni dell'area Internet.</span><span class="sxs-lookup"><span data-stu-id="a354d-133">In this case, the permission set of the Internet zone is used.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#2)]
    [!code-vb[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#2)]

2. <span data-ttu-id="a354d-134">Creare un oggetto <xref:System.AppDomainSetup> per inizializzare il dominio dell'applicazione con un percorso dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-134">Create an <xref:System.AppDomainSetup> object to initialize the application domain with an application path.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="a354d-135">Per semplicità, questo esempio di codice usa la cartella corrente.</span><span class="sxs-lookup"><span data-stu-id="a354d-135">For simplicity, this code example uses the current folder.</span></span> <span data-ttu-id="a354d-136">Per eseguire codice realmente proveniente da Internet, usare una cartella separata per il codice non attendibile, come descritto nella [procedura relativa all'esecuzione di codice parzialmente attendibile in un oggetto sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="a354d-136">To run code that actually comes from the Internet, use a separate folder for the untrusted code, as described in [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#3)]
    [!code-vb[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#3)]

3. <span data-ttu-id="a354d-137">Creare il dominio dell'applicazione, specificando le informazioni di configurazione del dominio dell'applicazione e il set di concessioni per tutti gli assembly eseguiti nel dominio dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-137">Create the application domain, specifying the application domain setup information and the grant set for all assemblies that execute in the application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#5)]
    [!code-vb[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#5)]

    <span data-ttu-id="a354d-138">L'ultimo parametro dell'overload del metodo <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> consente di specificare un set di assembly a cui deve essere concessa l'attendibilità totale, anziché il set di concessioni del dominio dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-138">The last parameter of the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload enables you to specify a set of assemblies that are to be granted full trust, instead of the grant set of the application domain.</span></span> <span data-ttu-id="a354d-139">Non è necessario specificare gli assembly .NET Framework usati dall'applicazione, perché si trovano nella Global Assembly Cache.</span><span class="sxs-lookup"><span data-stu-id="a354d-139">You do not have to specify the .NET Framework assemblies that your application uses, because those assemblies are in the global assembly cache.</span></span> <span data-ttu-id="a354d-140">Gli assembly nella Global Assembly Cache sono sempre completamente attendibili.</span><span class="sxs-lookup"><span data-stu-id="a354d-140">Assemblies in the global assembly cache are always fully trusted.</span></span> <span data-ttu-id="a354d-141">È possibile usare questo parametro per specificare assembly con nome sicuro che non sono presenti nella Global Assembly Cache.</span><span class="sxs-lookup"><span data-stu-id="a354d-141">You can use this parameter to specify strong-named assemblies that are not in the global assembly cache.</span></span>

### <a name="adding-restrictedmemberaccess-to-sandboxed-domains"></a><span data-ttu-id="a354d-142">Aggiunta di RestrictedMemberAccess ai domini sandbox</span><span class="sxs-lookup"><span data-stu-id="a354d-142">Adding RestrictedMemberAccess to Sandboxed Domains</span></span>

<span data-ttu-id="a354d-143">Le applicazioni host possono consentire ai metodi dinamici ospitati in modo anonimo di accedere ai dati privati negli assembly con livelli di attendibilità uguali o inferiori a quelli dell'assembly che genera il codice.</span><span class="sxs-lookup"><span data-stu-id="a354d-143">Host applications can allow anonymously hosted dynamic methods to have access to private data in assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span> <span data-ttu-id="a354d-144">Per abilitare la possibilità limitata di ignorare i controlli di visibilità just-in-time (JIT), l'applicazione host aggiunge un oggetto <xref:System.Security.Permissions.ReflectionPermission> con il flag <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) al set di concessioni.</span><span class="sxs-lookup"><span data-stu-id="a354d-144">To enable this restricted ability to skip just-in-time (JIT) visibility checks, the host application adds a <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) flag to the grant set.</span></span>

<span data-ttu-id="a354d-145">Ad esempio, un host può concedere alle applicazioni Internet autorizzazioni Internet più RMA, in modo tale che un'applicazione Internet sia in grado di generare codice che accede ai dati privati nei propri assembly.</span><span class="sxs-lookup"><span data-stu-id="a354d-145">For example, a host might grant Internet applications Internet permissions plus RMA, so that an Internet application can emit code that accesses private data in its own assemblies.</span></span> <span data-ttu-id="a354d-146">Poiché l'accesso è limitato agli assembly con attendibilità uguale o minore, un'applicazione Internet non può accedere a membri di assembly completamente attendibili, ad esempio gli assembly .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="a354d-146">Because the access is limited to assemblies of equal or lesser trust, an Internet application cannot access members of fully trusted assemblies such as .NET Framework assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="a354d-147">Per evitare l'elevazione dei privilegi, le informazioni sullo stack per l'assembly di creazione vengono incluse quando si creano metodi dinamici ospitati in modo anonimo.</span><span class="sxs-lookup"><span data-stu-id="a354d-147">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="a354d-148">Quando il metodo viene richiamato, vengono controllate le informazioni sullo stack.</span><span class="sxs-lookup"><span data-stu-id="a354d-148">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="a354d-149">Di conseguenza, un metodo dinamico ospitato in modo anonimo richiamato da codice completamente attendibile è comunque limitato al livello di attendibilità dell'assembly di creazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-149">Thus, an anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the emitting assembly.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust-plus-rma"></a><span data-ttu-id="a354d-150">Per creare un dominio dell'applicazione con attendibilità parziale più RMA</span><span class="sxs-lookup"><span data-stu-id="a354d-150">To create an application domain with partial trust plus RMA</span></span>

1. <span data-ttu-id="a354d-151">Creare un nuovo oggetto <xref:System.Security.Permissions.ReflectionPermission> con il flag <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) e usare il metodo <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> per aggiungere l'autorizzazione al set di concessioni.</span><span class="sxs-lookup"><span data-stu-id="a354d-151">Create a new <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) flag, and use the <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> method to add the permission to the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#7)]
    [!code-vb[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#7)]

    <span data-ttu-id="a354d-152">Il metodo <xref:System.Security.PermissionSet.AddPermission%2A> aggiunge l'autorizzazione al set di concessioni, se non è già inclusa.</span><span class="sxs-lookup"><span data-stu-id="a354d-152">The <xref:System.Security.PermissionSet.AddPermission%2A> method adds the permission to the grant set if it is not already included.</span></span> <span data-ttu-id="a354d-153">Se l'autorizzazione è già inclusa nel set di concessioni, i flag specificati vengono aggiunti all'autorizzazione esistente.</span><span class="sxs-lookup"><span data-stu-id="a354d-153">If the permission is already included in the grant set, the specified flags are added to the existing permission.</span></span>

    > [!NOTE]
    > <span data-ttu-id="a354d-154">RMA è una funzionalità dei metodi dinamici ospitati in modo anonimo.</span><span class="sxs-lookup"><span data-stu-id="a354d-154">RMA is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="a354d-155">Quando i metodi dinamici comuni ignorano i controlli di visibilità JIT, il codice generato richiede l'attendibilità totale.</span><span class="sxs-lookup"><span data-stu-id="a354d-155">When ordinary dynamic methods skip JIT visibility checks, the emitted code requires full trust.</span></span>

2. <span data-ttu-id="a354d-156">Creare il dominio dell'applicazione, specificando le informazioni di configurazione del dominio dell'applicazione e il set di concessioni.</span><span class="sxs-lookup"><span data-stu-id="a354d-156">Create the application domain, specifying the application domain setup information and the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#8)]
    [!code-vb[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#8)]

<a name="Running_code"></a>

## <a name="running-code-in-sandboxed-application-domains"></a><span data-ttu-id="a354d-157">Esecuzione di codice nei domini dell'applicazione sandbox</span><span class="sxs-lookup"><span data-stu-id="a354d-157">Running Code in Sandboxed Application Domains</span></span>

<span data-ttu-id="a354d-158">La procedura seguente spiega come definire una classe usando metodi che possono essere eseguiti in un dominio dell'applicazione, come creare un'istanza della classe nel dominio e come eseguire i relativi metodi.</span><span class="sxs-lookup"><span data-stu-id="a354d-158">The following procedure explains how to define a class by using methods that can be executed in an application domain, how to create an instance of the class in the domain, and how to execute its methods.</span></span>

#### <a name="to-define-and-execute-a-method-in-an-application-domain"></a><span data-ttu-id="a354d-159">Per definire ed eseguire un metodo in un dominio dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="a354d-159">To define and execute a method in an application domain</span></span>

1. <span data-ttu-id="a354d-160">Definire una classe che deriva da <xref:System.MarshalByRefObject>.</span><span class="sxs-lookup"><span data-stu-id="a354d-160">Define a class that derives from <xref:System.MarshalByRefObject>.</span></span> <span data-ttu-id="a354d-161">Ciò consente di creare istanze della classe in altri domini dell'applicazione e di effettuare chiamate al metodo tra i limiti del dominio dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-161">This enables you to create instances of the class in other application domains and to make method calls across application domain boundaries.</span></span> <span data-ttu-id="a354d-162">La classe di questo esempio è denominata `Worker`.</span><span class="sxs-lookup"><span data-stu-id="a354d-162">The class in this example is named `Worker`.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#10)]
    [!code-vb[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#10)]

2. <span data-ttu-id="a354d-163">Definire un metodo pubblico che contenga il codice da eseguire.</span><span class="sxs-lookup"><span data-stu-id="a354d-163">Define a public method that contains the code you want to execute.</span></span> <span data-ttu-id="a354d-164">In questo esempio, il codice genera un metodo dinamico semplice, crea un delegato per eseguire il metodo e richiama il delegato.</span><span class="sxs-lookup"><span data-stu-id="a354d-164">In this example, the code emits a simple dynamic method, creates a delegate to execute the method, and invokes the delegate.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#11)]
    [!code-vb[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#11)]

3. <span data-ttu-id="a354d-165">Nel programma principale ottenere il nome visualizzato dell'assembly.</span><span class="sxs-lookup"><span data-stu-id="a354d-165">In your main program, get the display name of your assembly.</span></span> <span data-ttu-id="a354d-166">Questo nome viene usato quando si creano istanze della classe `Worker` nel dominio dell'applicazione sandbox.</span><span class="sxs-lookup"><span data-stu-id="a354d-166">This name is used when you create instances of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#14)]
    [!code-vb[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#14)]

4. <span data-ttu-id="a354d-167">Nel programma principale creare un dominio dell'applicazione sandbox, come descritto nella [prima procedura](#Setting_up) in questa procedura dettagliata.</span><span class="sxs-lookup"><span data-stu-id="a354d-167">In your main program, create a sandboxed application domain, as described in [the first procedure](#Setting_up) in this walkthrough.</span></span> <span data-ttu-id="a354d-168">Non è necessario aggiungere autorizzazioni al set di autorizzazioni `Internet`, poiché il metodo `SimpleEmitDemo` usa solo metodi pubblici.</span><span class="sxs-lookup"><span data-stu-id="a354d-168">You do not have to add any permissions to the `Internet` permission set, because the `SimpleEmitDemo` method uses only public methods.</span></span>

5. <span data-ttu-id="a354d-169">Nel programma principale creare un'istanza della classe `Worker` nel dominio dell'applicazione sandbox.</span><span class="sxs-lookup"><span data-stu-id="a354d-169">In your main program, create an instance of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#12)]
    [!code-vb[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#12)]

    <span data-ttu-id="a354d-170">Il metodo <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> crea l'oggetto nel dominio dell'applicazione di destinazione e restituisce un proxy che può essere usato per chiamare le proprietà e metodi dell'oggetto.</span><span class="sxs-lookup"><span data-stu-id="a354d-170">The <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method creates the object in the target application domain and returns a proxy that can be used to call the properties and methods of the object.</span></span>

    > [!NOTE]
    > <span data-ttu-id="a354d-171">Se questo codice viene utilizzato in Visual Studio, è necessario modificare il nome della classe per includere lo spazio dei nomi.</span><span class="sxs-lookup"><span data-stu-id="a354d-171">If you use this code in Visual Studio, you must change the name of the class to include the namespace.</span></span> <span data-ttu-id="a354d-172">Per impostazione predefinita, lo spazio dei nomi è il nome del progetto.</span><span class="sxs-lookup"><span data-stu-id="a354d-172">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="a354d-173">Ad esempio, se il progetto è "PartialTrust", il nome della classe deve essere "PartialTrust.Worker".</span><span class="sxs-lookup"><span data-stu-id="a354d-173">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

6. <span data-ttu-id="a354d-174">Aggiungere il codice per chiamare il metodo `SimpleEmitDemo` .</span><span class="sxs-lookup"><span data-stu-id="a354d-174">Add code to call the `SimpleEmitDemo` method.</span></span> <span data-ttu-id="a354d-175">La chiamata viene sottoposta a marshalling entro i limiti del dominio dell'applicazione e il codice viene eseguito nel dominio dell'applicazione sandbox.</span><span class="sxs-lookup"><span data-stu-id="a354d-175">The call is marshaled across the application domain boundary, and the code is executed in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#13)]
    [!code-vb[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#13)]

<a name="Using_methods"></a>

## <a name="using-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="a354d-176">Uso dei metodi dinamici ospitati in modo anonimo</span><span class="sxs-lookup"><span data-stu-id="a354d-176">Using Anonymously Hosted Dynamic Methods</span></span>

<span data-ttu-id="a354d-177">I metodi dinamici ospitati in modo anonimo sono associati a un assembly trasparente messo a disposizione dal sistema.</span><span class="sxs-lookup"><span data-stu-id="a354d-177">Anonymously hosted dynamic methods are associated with a transparent assembly that is provided by the system.</span></span> <span data-ttu-id="a354d-178">Di conseguenza, il codice che contengono è trasparente.</span><span class="sxs-lookup"><span data-stu-id="a354d-178">Therefore, the code they contain is transparent.</span></span> <span data-ttu-id="a354d-179">I metodi dinamici comuni, d'altra parte, devono essere associati a un modulo esistente, specificato direttamente o derivato da un tipo associato, e ricevono il livello di sicurezza da tale modulo.</span><span class="sxs-lookup"><span data-stu-id="a354d-179">Ordinary dynamic methods, on the other hand, must be associated with an existing module (whether directly specified or inferred from an associated type), and take their security level from that module.</span></span>

> [!NOTE]
> <span data-ttu-id="a354d-180">L'unico modo di associare un metodo dinamico all'assembly che offre l'hosting anonimo è usare i costruttori descritti nella procedura seguente.</span><span class="sxs-lookup"><span data-stu-id="a354d-180">The only way to associate a dynamic method with the assembly that provides anonymous hosting is to use the constructors that are described in the following procedure.</span></span> <span data-ttu-id="a354d-181">Non è possibile specificare in modo esplicito un modulo nell'assembly di hosting anonimo.</span><span class="sxs-lookup"><span data-stu-id="a354d-181">You cannot explicitly specify a module in the anonymous hosting assembly.</span></span>

<span data-ttu-id="a354d-182">I metodi dinamici comuni hanno accesso ai membri interni del modulo a cui sono associati o ai membri privati del tipo a cui sono associati.</span><span class="sxs-lookup"><span data-stu-id="a354d-182">Ordinary dynamic methods have access to the internal members of the module they are associated with, or to the private members of the type they are associated with.</span></span> <span data-ttu-id="a354d-183">Poiché i metodi dinamici ospitati in modo anonimo sono isolati dall'altro codice, non hanno accesso ai dati privati.</span><span class="sxs-lookup"><span data-stu-id="a354d-183">Because anonymously hosted dynamic methods are isolated from other code, they do not have access to private data.</span></span> <span data-ttu-id="a354d-184">Usano tuttavia una possibilità limitata per ignorare i controlli di visibilità JIT in modo da ottenere l'accesso ai dati privati.</span><span class="sxs-lookup"><span data-stu-id="a354d-184">However, they do have a restricted ability to skip JIT visibility checks to gain access to private data.</span></span> <span data-ttu-id="a354d-185">Tale possibilità è limitata agli assembly con livelli di attendibilità uguali o inferiori a quello dell'assembly che genera il codice.</span><span class="sxs-lookup"><span data-stu-id="a354d-185">This ability is limited to assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span>

<span data-ttu-id="a354d-186">Per evitare l'elevazione dei privilegi, le informazioni sullo stack per l'assembly di creazione vengono incluse quando si creano metodi dinamici ospitati in modo anonimo.</span><span class="sxs-lookup"><span data-stu-id="a354d-186">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="a354d-187">Quando il metodo viene richiamato, vengono controllate le informazioni sullo stack.</span><span class="sxs-lookup"><span data-stu-id="a354d-187">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="a354d-188">Un metodo dinamico ospitato in modo anonimo richiamato da un codice completamente attendibile è comunque limitato al livello di attendibilità dell'assembly in cui è stato creato.</span><span class="sxs-lookup"><span data-stu-id="a354d-188">An anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the assembly that emitted it.</span></span>

#### <a name="to-use-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="a354d-189">Per usare i metodi dinamici ospitati in modo anonimo</span><span class="sxs-lookup"><span data-stu-id="a354d-189">To use anonymously hosted dynamic methods</span></span>

- <span data-ttu-id="a354d-190">Creare un metodo dinamico ospitato in modo anonimo usando un costruttore che non specifica un modulo o un tipo associato.</span><span class="sxs-lookup"><span data-stu-id="a354d-190">Create an anonymously hosted dynamic method by using a constructor that does not specify an associated module or type.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#15)]
  [!code-vb[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#15)]

  <span data-ttu-id="a354d-191">Se un metodo dinamico ospitato in modo anonimo usa solo tipi e metodi pubblici, non richiede l'accesso limitato al membro e non è necessario ignorare i controlli di visibilità JIT.</span><span class="sxs-lookup"><span data-stu-id="a354d-191">If an anonymously hosted dynamic method uses only public types and methods, it does not require restricted member access and does not have to skip JIT visibility checks.</span></span>

  <span data-ttu-id="a354d-192">Non sono richieste autorizzazioni speciali per generare un metodo dinamico, ma per il codice generato sono necessarie le autorizzazioni obbligatorie per i tipi e i metodi usati.</span><span class="sxs-lookup"><span data-stu-id="a354d-192">No special permissions are required to emit a dynamic method, but the emitted code requires the permissions that are demanded by the types and methods it uses.</span></span> <span data-ttu-id="a354d-193">Ad esempio, se il codice generato chiama un metodo che accede a un file, richiede <xref:System.Security.Permissions.FileIOPermission>.</span><span class="sxs-lookup"><span data-stu-id="a354d-193">For example, if the emitted code calls a method that accesses a file, it requires <xref:System.Security.Permissions.FileIOPermission>.</span></span> <span data-ttu-id="a354d-194">Se il livello di attendibilità non include tale autorizzazione, viene generata un'eccezione di sicurezza quando viene eseguito il codice generato.</span><span class="sxs-lookup"><span data-stu-id="a354d-194">If the trust level does not include that permission, a security exception is thrown when the emitted code is executed.</span></span> <span data-ttu-id="a354d-195">Il codice riportato di seguito genera un metodo dinamico che usa solo il metodo <xref:System.Console.WriteLine%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="a354d-195">The code shown here emits a dynamic method that uses only the <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="a354d-196">Di conseguenza, il codice può essere eseguito da percorsi parzialmente attendibili.</span><span class="sxs-lookup"><span data-stu-id="a354d-196">Therefore, the code can be executed from partially trusted locations.</span></span>

- <span data-ttu-id="a354d-197">In alternativa, creare un metodo dinamico ospitato in modo anonimo con la possibilità limitata di ignorare i controlli di visibilità JIT, usando il costruttore <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> e specificando `true` per il parametro `restrictedSkipVisibility`.</span><span class="sxs-lookup"><span data-stu-id="a354d-197">Alternatively, create an anonymously hosted dynamic method with restricted ability to skip JIT visibility checks, by using the <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> constructor and specifying `true` for the `restrictedSkipVisibility` parameter.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#16)]
  [!code-vb[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#16)]

  <span data-ttu-id="a354d-198">La limitazione consiste nel fatto che il metodo dinamico ospitato in modo anonimo può accedere ai dati privati solo negli assembly con livelli di attendibilità uguali o inferiori a quello dell'assembly di creazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-198">The restriction is that the anonymously hosted dynamic method can access private data only in assemblies with trust levels equal to or less than the trust level of the emitting assembly.</span></span> <span data-ttu-id="a354d-199">Ad esempio, se il metodo dinamico è in esecuzione con attendibilità Internet, può accedere ai dati privati in altri assembly in esecuzione con attendibilità Internet, ma non può accedere ai dati privati degli assembly .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="a354d-199">For example, if the dynamic method is executing with Internet trust, it can access private data in other assemblies that are also executing with Internet trust, but it cannot access private data of .NET Framework assemblies.</span></span> <span data-ttu-id="a354d-200">Gli assembly .NET Framework sono installati nella Global Assembly Cache e sono sempre completamente attendibili.</span><span class="sxs-lookup"><span data-stu-id="a354d-200">.NET Framework assemblies are installed in the global assembly cache and are always fully trusted.</span></span>

  <span data-ttu-id="a354d-201">I metodi dinamici ospitati in modo anonimo possono usare questa possibilità limitata di ignorare i controlli di visibilità JIT solo se l'applicazione host concede <xref:System.Security.Permissions.ReflectionPermission> con il flag <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="a354d-201">Anonymously hosted dynamic methods can use this restricted ability to skip JIT visibility checks only if the host application grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="a354d-202">La richiesta di questa autorizzazione viene effettuata quando viene richiamato il metodo.</span><span class="sxs-lookup"><span data-stu-id="a354d-202">The demand for this permission is made when the method is invoked.</span></span>

  > [!NOTE]
  > <span data-ttu-id="a354d-203">Le informazioni sullo stack di chiamate per l'assembly di creazione vengono incluse quando viene costruito il metodo dinamico.</span><span class="sxs-lookup"><span data-stu-id="a354d-203">Call stack information for the emitting assembly is included when the dynamic method is constructed.</span></span> <span data-ttu-id="a354d-204">Di conseguenza, la richiesta viene effettuata facendo riferimento alle autorizzazioni dell'assembly di creazione anziché a quelle dell'assembly che richiama il metodo.</span><span class="sxs-lookup"><span data-stu-id="a354d-204">Therefore, the demand is made against the permissions of the emitting assembly instead of the assembly that invokes the method.</span></span> <span data-ttu-id="a354d-205">Ciò impedisce che il codice generato venga eseguito con autorizzazioni elevate.</span><span class="sxs-lookup"><span data-stu-id="a354d-205">This prevents the emitted code from being executed with elevated permissions.</span></span>

  <span data-ttu-id="a354d-206">L'[esempio di codice completo](#Example) alla fine di questa procedura dettagliata illustra l'uso e le limitazioni dell'accesso limitato al membro.</span><span class="sxs-lookup"><span data-stu-id="a354d-206">The [complete code example](#Example) at the end of this walkthrough demonstrates the use and limitations of restricted member access.</span></span> <span data-ttu-id="a354d-207">La relativa classe `Worker` include un metodo in grado di creare metodi dinamici ospitati in modo anonimo con o senza la possibilità limitata di ignorare i controlli di visibilità e l'esempio illustra il risultato dell'esecuzione di questo metodo nei domini dell'applicazione con diversi livelli di attendibilità.</span><span class="sxs-lookup"><span data-stu-id="a354d-207">Its `Worker` class includes a method that can create anonymously hosted dynamic methods with or without the restricted ability to skip visibility checks, and the example shows the result of executing this method in application domains that have different trust levels.</span></span>

  > [!NOTE]
  > <span data-ttu-id="a354d-208">La possibilità limitata di ignorare i controlli di visibilità è una funzionalità di metodi dinamici ospitati in modo anonimo.</span><span class="sxs-lookup"><span data-stu-id="a354d-208">The restricted ability to skip visibility checks is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="a354d-209">Quando i metodi dinamici comuni ignorano i controlli di visibilità JIT, deve essere concessa l'attendibilità totale.</span><span class="sxs-lookup"><span data-stu-id="a354d-209">When ordinary dynamic methods skip JIT visibility checks, they must be granted full trust.</span></span>

<a name="Example"></a>

## <a name="example"></a><span data-ttu-id="a354d-210">Esempio</span><span class="sxs-lookup"><span data-stu-id="a354d-210">Example</span></span>

### <a name="description"></a><span data-ttu-id="a354d-211">Descrizione</span><span class="sxs-lookup"><span data-stu-id="a354d-211">Description</span></span>

<span data-ttu-id="a354d-212">Nell'esempio di codice riportato di seguito viene illustrato l'uso del flag <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> per consentire ai metodi dinamici ospitati in modo anonimo di ignorare i controlli di visibilità JIT, ma solo quando il membro di destinazione è un livello uguale o inferiore di attendibilità rispetto all'assembly che genera il codice.</span><span class="sxs-lookup"><span data-stu-id="a354d-212">The following code example demonstrates the use of the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> flag to allow anonymously hosted dynamic methods to skip JIT visibility checks, but only when the target member is at an equal or lower level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="a354d-213">Nell'esempio viene definita una classe `Worker` che può essere sottoposta a marshalling entro i limiti del dominio dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="a354d-213">The example defines a `Worker` class that can be marshaled across application domain boundaries.</span></span> <span data-ttu-id="a354d-214">La classe ha due overload del metodo `AccessPrivateMethod` che generano ed eseguono i metodi dinamici.</span><span class="sxs-lookup"><span data-stu-id="a354d-214">The class has two `AccessPrivateMethod` method overloads that emit and execute dynamic methods.</span></span> <span data-ttu-id="a354d-215">Il primo overload genera un metodo dinamico che chiama il metodo privato `PrivateMethod` della classe `Worker` e può generare il metodo dinamico con o senza controlli di visibilità JIT.</span><span class="sxs-lookup"><span data-stu-id="a354d-215">The first overload emits a dynamic method that calls the private `PrivateMethod` method of the `Worker` class, and it can emit the dynamic method with or without JIT visibility checks.</span></span> <span data-ttu-id="a354d-216">Il secondo overload genera un metodo dinamico che accede a una proprietà `internal` (proprietà `Friend` in Visual Basic) della classe <xref:System.String>.</span><span class="sxs-lookup"><span data-stu-id="a354d-216">The second overload emits a dynamic method that accesses an `internal` property (`Friend` property in Visual Basic) of the <xref:System.String> class.</span></span>

<span data-ttu-id="a354d-217">L'esempio usa un metodo helper per creare un set di concessioni limitato alle autorizzazioni `Internet`, quindi crea un dominio dell'applicazione usando l'overload del metodo <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> per specificare che tutto il codice eseguito nel dominio usa questo set di concessioni.</span><span class="sxs-lookup"><span data-stu-id="a354d-217">The example uses a helper method to create a grant set limited to `Internet` permissions, and then creates an application domain, using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to specify that all code that executes in the domain uses this grant set.</span></span> <span data-ttu-id="a354d-218">Nell'esempio viene creata un'istanza della classe `Worker` nel dominio dell'applicazione e viene eseguito due volte il metodo `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="a354d-218">The example creates an instance of the `Worker` class in the application domain, and executes the `AccessPrivateMethod` method two times.</span></span>

- <span data-ttu-id="a354d-219">La prima volta che il metodo `AccessPrivateMethod` viene eseguito, vengono applicati i controlli di visibilità JIT.</span><span class="sxs-lookup"><span data-stu-id="a354d-219">The first time the `AccessPrivateMethod` method is executed, JIT visibility checks are enforced.</span></span> <span data-ttu-id="a354d-220">Il metodo dinamico ha esito negativo quando viene richiamato, perché i controlli di visibilità JIT impediscono l'accesso al metodo privato.</span><span class="sxs-lookup"><span data-stu-id="a354d-220">The dynamic method fails when it is invoked, because JIT visibility checks prevent it from accessing the private method.</span></span>

- <span data-ttu-id="a354d-221">La seconda volta che il metodo `AccessPrivateMethod` viene eseguito, i controlli di visibilità JIT vengono ignorati.</span><span class="sxs-lookup"><span data-stu-id="a354d-221">The second time the `AccessPrivateMethod` method is executed, JIT visibility checks are skipped.</span></span> <span data-ttu-id="a354d-222">Il metodo dinamico ha esito negativo quando viene compilato, poiché il set di concessioni `Internet` non concede autorizzazioni sufficienti per ignorare i controlli di visibilità.</span><span class="sxs-lookup"><span data-stu-id="a354d-222">The dynamic method fails when it is compiled, because the `Internet` grant set does not grant sufficient permissions to skip visibility checks.</span></span>

<span data-ttu-id="a354d-223">Nell'esempio viene aggiunto <xref:System.Security.Permissions.ReflectionPermission> con <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> al set di concessioni.</span><span class="sxs-lookup"><span data-stu-id="a354d-223">The example adds <xref:System.Security.Permissions.ReflectionPermission> with <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> to the grant set.</span></span> <span data-ttu-id="a354d-224">Viene quindi creato un secondo dominio, specificando che a tutto il codice eseguito nel dominio vengano concesse le autorizzazioni del nuovo set di concessioni.</span><span class="sxs-lookup"><span data-stu-id="a354d-224">The example then creates a second domain, specifying that all code that executes in the domain is granted the permissions in the new grant set.</span></span> <span data-ttu-id="a354d-225">Viene creata un'istanza della classe `Worker` nel nuovo dominio dell'applicazione e vengono eseguiti entrambi gli overload del metodo `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="a354d-225">The example creates an instance of the `Worker` class in the new application domain, and executes both overloads of the `AccessPrivateMethod` method.</span></span>

- <span data-ttu-id="a354d-226">Viene eseguito il primo overload del metodo `AccessPrivateMethod` e i controlli di visibilità JIT vengono ignorati.</span><span class="sxs-lookup"><span data-stu-id="a354d-226">The first overload of the `AccessPrivateMethod` method is executed, and JIT visibility checks are skipped.</span></span> <span data-ttu-id="a354d-227">Il metodo dinamico viene compilato ed eseguito correttamente, poiché l'assembly che genera il codice è lo stesso assembly che contiene il metodo privato.</span><span class="sxs-lookup"><span data-stu-id="a354d-227">The dynamic method compiles and executes successfully, because the assembly that emits the code is the same as the assembly that contains the private method.</span></span> <span data-ttu-id="a354d-228">Di conseguenza, i livelli di attendibilità sono uguali.</span><span class="sxs-lookup"><span data-stu-id="a354d-228">Therefore, the trust levels are equal.</span></span> <span data-ttu-id="a354d-229">Se l'applicazione che contiene la classe `Worker` ha diversi assembly, l'esito del processo sarà lo stesso per tutti gli assembly, poiché sono tutti allo stesso livello di attendibilità.</span><span class="sxs-lookup"><span data-stu-id="a354d-229">If the application that contains the `Worker` class had several assemblies, the same process would succeed for any one of those assemblies, because they would all be at the same trust level.</span></span>

- <span data-ttu-id="a354d-230">Viene eseguito il secondo overload del metodo `AccessPrivateMethod` e i controlli di visibilità JIT vengono di nuovo ignorati.</span><span class="sxs-lookup"><span data-stu-id="a354d-230">The second overload of the `AccessPrivateMethod` method is executed, and again JIT visibility checks are skipped.</span></span> <span data-ttu-id="a354d-231">Questa volta il metodo dinamico ha esito negativo quando viene compilato, perché tenta di accedere alla `internal` `FirstChar` proprietà della <xref:System.String> classe.</span><span class="sxs-lookup"><span data-stu-id="a354d-231">This time the dynamic method fails when it is compiled, because it tries to access the `internal` `FirstChar` property of the <xref:System.String> class.</span></span> <span data-ttu-id="a354d-232">L'assembly che contiene la classe <xref:System.String> è completamente attendibile.</span><span class="sxs-lookup"><span data-stu-id="a354d-232">The assembly that contains the <xref:System.String> class is fully trusted.</span></span> <span data-ttu-id="a354d-233">Si trova quindi a un livello di attendibilità superiore rispetto all'assembly che genera il codice.</span><span class="sxs-lookup"><span data-stu-id="a354d-233">Therefore, it is at a higher level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="a354d-234">Questo confronto spiega come <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> consente al codice parzialmente attendibile di ignorare i controlli di visibilità per altro codice parzialmente attendibile senza compromettere la sicurezza del codice attendibile.</span><span class="sxs-lookup"><span data-stu-id="a354d-234">This comparison shows how <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> enables partially trusted code to skip visibility checks for other partially trusted code without compromising the security of trusted code.</span></span>

### <a name="code"></a><span data-ttu-id="a354d-235">Codice</span><span class="sxs-lookup"><span data-stu-id="a354d-235">Code</span></span>

[!code-csharp[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#1)]
[!code-vb[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#1)]

## <a name="compiling-the-code"></a><span data-ttu-id="a354d-236">Compilazione del codice</span><span class="sxs-lookup"><span data-stu-id="a354d-236">Compiling the Code</span></span>

- <span data-ttu-id="a354d-237">Se si compila questo esempio di codice in Visual Studio, è necessario modificare il nome della classe in modo che includa lo spazio dei nomi quando si passa la classe al metodo <xref:System.AppDomain.CreateInstanceAndUnwrap%2A>.</span><span class="sxs-lookup"><span data-stu-id="a354d-237">If you build this code example in Visual Studio, you must change the name of the class to include the namespace when you pass it to the <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method.</span></span> <span data-ttu-id="a354d-238">Per impostazione predefinita, lo spazio dei nomi è il nome del progetto.</span><span class="sxs-lookup"><span data-stu-id="a354d-238">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="a354d-239">Ad esempio, se il progetto è "PartialTrust", il nome della classe deve essere "PartialTrust.Worker".</span><span class="sxs-lookup"><span data-stu-id="a354d-239">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

## <a name="see-also"></a><span data-ttu-id="a354d-240">Vedi anche</span><span class="sxs-lookup"><span data-stu-id="a354d-240">See also</span></span>

- [<span data-ttu-id="a354d-241">Problemi di sicurezza nella reflection emit</span><span class="sxs-lookup"><span data-stu-id="a354d-241">Security Issues in Reflection Emit</span></span>](security-issues-in-reflection-emit.md)
- [<span data-ttu-id="a354d-242">Procedura: eseguire codice parzialmente attendibile in un oggetto sandbox</span><span class="sxs-lookup"><span data-stu-id="a354d-242">How to: Run Partially Trusted Code in a Sandbox</span></span>](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)
